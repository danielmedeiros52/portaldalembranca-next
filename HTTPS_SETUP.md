# HTTPS Setup for Local Development

## Why HTTPS is Required

Mercado Pago's CardForm requires HTTPS for secure card data handling. Without HTTPS, browsers will show a security warning and block the form from loading properly.

**Warning message**: "This page is not using a secure connection. Your card information may be at risk."

---

## Quick Setup (Windows)

### Step 1: Run the Setup Script

```bash
pnpm setup:https
```

This will:
1. Install `mkcert` (if not installed)
2. Install a local Certificate Authority
3. Generate SSL certificates for localhost

**Note**: The script may prompt for administrator permissions - this is normal and required for installing the CA.

---

### Step 2: Start the HTTPS Dev Server

```bash
pnpm dev:https
```

Your application will be available at: **https://localhost:3000**

**Important**: Use `https://` (not `http://`)

---

### Step 3: Accept the Certificate (First Time Only)

When you first visit https://localhost:3000, your browser may show a warning. This is normal for self-signed certificates.

**Chrome/Edge**:
- Click "Advanced"
- Click "Proceed to localhost (unsafe)"

**Firefox**:
- Click "Advanced"
- Click "Accept the Risk and Continue"

**Note**: If you ran the setup script correctly with admin permissions, the certificate should be trusted and you won't see this warning.

---

## Manual Setup (Alternative)

If the automated script doesn't work, follow these manual steps:

### 1. Install Chocolatey (if not installed)

Run PowerShell as Administrator:

```powershell
Set-ExecutionPolicy Bypass -Scope Process -Force
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
```

### 2. Install mkcert

```bash
choco install mkcert -y
```

### 3. Install Local CA

```bash
mkcert -install
```

### 4. Generate Certificates

Navigate to your project directory:

```bash
cd C:\Users\xb72\Desktop\personal\portaldalembranca-next
mkcert -key-file localhost-key.pem -cert-file localhost-cert.pem localhost 127.0.0.1 ::1
```

### 5. Start HTTPS Server

```bash
pnpm dev:https
```

---

## Troubleshooting

### Issue: "mkcert command not found"

**Solution**:
1. Make sure Chocolatey is installed
2. Run `choco install mkcert -y`
3. Restart your terminal
4. Try again

---

### Issue: "Cannot find module 'https'"

**Solution**: This shouldn't happen as `https` is a Node.js built-in module. Make sure you're using Node.js 20+.

Check your Node version:
```bash
node --version
```

---

### Issue: "Port 3000 is already in use"

**Solution**:
1. Stop any other dev servers running on port 3000
2. Check for `pnpm dev` or `next dev` processes
3. Kill them and try again

On Windows:
```powershell
netstat -ano | findstr :3000
taskkill /PID <process_id> /F
```

---

### Issue: Browser still shows security warning

**Solution 1**: Make sure you ran `mkcert -install` with administrator permissions

**Solution 2**: Manually trust the certificate in your browser

**Chrome/Edge**:
1. Open Chrome Settings
2. Search for "Manage certificates"
3. Go to "Trusted Root Certification Authorities"
4. Import `localhost-cert.pem`

**Firefox**:
1. Open Firefox Settings
2. Search for "Certificates"
3. Click "View Certificates"
4. Import `localhost-cert.pem`

---

### Issue: CardForm still shows insecure connection warning

**Solution**:
1. Clear browser cache and cookies
2. Make sure you're accessing via `https://` (not `http://`)
3. Verify the certificate is installed: `mkcert -install`
4. Restart your browser completely

---

## Development Workflow

### Regular Development (No Card Payments)
Use the standard dev server:
```bash
pnpm dev
```
Access at: http://localhost:3000

### Testing Card Payments
Use the HTTPS dev server:
```bash
pnpm dev:https
```
Access at: https://localhost:3000

---

## Files Created

The setup creates these files in your project root:

- `localhost-key.pem` - Private key (never commit)
- `localhost-cert.pem` - Certificate (never commit)
- `server.mjs` - Custom HTTPS server

**Note**: These files are already in `.gitignore` (*.pem)

---

## Production Deployment

**Important**: You don't need these certificates for production!

Production platforms (Vercel, Netlify, etc.) automatically provide HTTPS. This setup is only for local development.

When deploying:
1. Push your code (certificates won't be included)
2. Your platform will provide HTTPS automatically
3. Mercado Pago will work without any additional configuration

---

## Security Notes

### Local Certificates

- The certificates generated by `mkcert` are **only for development**
- They are trusted **only on your computer**
- They are **not valid for production**
- Other team members need to run `pnpm setup:https` on their machines

### mkcert Safety

`mkcert` is safe because:
- Created by a Google employee (Filippo Valsorda)
- Open source and widely used
- Only installs a CA on your local machine
- Certificates are only valid for localhost
- Doesn't affect your system's security

---

## Alternative: Using Cloudflare Tunnel (Advanced)

If you want a public HTTPS URL for testing:

### 1. Install Cloudflare Tunnel

```bash
# Windows (Chocolatey)
choco install cloudflared

# Or download from: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/
```

### 2. Start Regular Dev Server

```bash
pnpm dev
```

### 3. Create Tunnel

```bash
cloudflared tunnel --url http://localhost:3000
```

This gives you a public HTTPS URL like: `https://random-name.trycloudflare.com`

**Pros**:
- Real HTTPS without setup
- Can share with others for testing
- Works on mobile devices

**Cons**:
- Requires internet connection
- URL changes each time
- Slower than local development

---

## Summary

**Quick Start**:
```bash
# One-time setup
pnpm setup:https

# Every time you develop with card payments
pnpm dev:https

# Access at
https://localhost:3000
```

That's it! The Mercado Pago CardForm will now work without security warnings.

---

## Need Help?

- **mkcert Documentation**: https://github.com/FiloSottile/mkcert
- **Mercado Pago Docs**: https://www.mercadopago.com.br/developers
- **Next.js Custom Server**: https://nextjs.org/docs/pages/building-your-application/configuring/custom-server
